#!/usr/bin/python

import itertools
import os
import lxml.html
from lxml.html import builder as E


import cachefetch
import blogpost
import sequence
import sequences

FIRST_POST = "http://lesswrong.com/lw/gn/the_martial_art_of_rationality/"
TITLE = "Eliezer Yudkowsky. Lesswrong.com blog posts, 2006-2013."

def scrape_all(start_url, sequencer):
    posts = list(collect_urls(start_url, sequencer))
    codemap = create_codemap(posts)
    read_articles(posts)
    fix_urls(posts, codemap)
    sequencelist = list(make_sequences(codemap))
    write_posts(posts)
    write_index(posts)
    write_sequences(sequencelist)
    save_sequences_list(sequencelist)
    print "Done"

def collect_urls(start_url, sequencer):
    print "Collecting URLs"
    url = start_url
    for seq in sequencer:
        print "...", url
        post = blogpost.Blogpost(seq, url)
        yield post
        url = post.get_nexturl()
        if url is None:
            break

def create_codemap(posts):
    return dict((p.code, p) for p in posts)

def read_articles(posts):
    print "Reading articles"
    for i, post in enumerate(posts):
        print u"{0:3}/{1:3} {2}".format(i+1, len(posts), post.url)
        post.read()

def fix_urls(posts, codemap):
    print "Fixing URLs"
    for post in posts:
        post.fix_urls(codemap)

def make_sequences(codemap):
    print "Making Sequences"
    for title, url, xpath in sequences.sequences:
        print "    ", title
        seq = sequence.Sequence(title)
        lx = cachefetch.get_html_from_url(url)
        for href in lx.xpath(xpath):
            code = blogpost.urltocode(href)
            if code is not None and code in codemap:
                p = codemap[code]
                seq.append(p)
                p.addseq(seq)
            #else:
            #    print "    ", href
        yield seq

def write_posts(posts):
    print "Writing posts"
    for post in posts:
        post.write()

def write_index(posts):
    print "Writing index"
    with open("target/index.html", "w") as f:
        f.write(lxml.html.tostring(
            E.HTML(
                E.HEAD(
                    E.TITLE(TITLE),
                ), E.BODY(
                    E.H1(TITLE),
                    E.H3("In sequence order:"),
                    E.UL(E.LI(E.A("Sequences", href="sequences.html"))),
                    E.H3("In chronological order:"),
                    E.UL(*[p.li() for p in posts])
                )
            )))

def write_sequences(sequencelist):
    print "Writing sequences"
    with open("target/sequences.html", "w") as f:
        f.write(lxml.html.tostring(
            E.HTML(
                E.HEAD(
                    E.TITLE("Sequences"),
                ), E.BODY(
                    E.H1("Sequences"),
                    E.UL(*[E.LI(E.B(s.title()),
                                E.UL(*[p.li() for p in s]))
                           for s in sequencelist
                           if s.has_posts()])
                )
            )))

def save_sequences_list(sequencelist):
    with open("sequences.org", "w") as f:
        for s in sequencelist:
            f.write("* {0}\n".format(s.title()))
            for p in s:
                f.write("  - {0}\n".format(p.url))
            f.write("\n")

def main():
    os.mkdir("target")
    sequencer = itertools.count(1)
    scrape_all(FIRST_POST, sequencer)
    #for e in sorted(blogpost.allattrs):
    #    print e

if __name__ == '__main__':
    main()
